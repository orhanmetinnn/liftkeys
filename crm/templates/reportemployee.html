{% extends "crmtemplates/base.html" %}
{% block content %}
{% load static %}
{% load i18n %}
{% comment %} <h1>{% trans "Welcome to Liftkeys" %}</h1> {% endcomment %}
    <div class="container py-5">
        <div class="glass-card mx-auto col-lg-12" data-aos="fade-up">
            <h1 class="mb-4 fw-bold" style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">Personel Raporu</h1>
            <p class="lead">Toplam Personel: <strong>{{ total_employees }}</strong></p>

        <!-- Grafikler Row -->
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="card shadow-sm p-3 h-100">
                        <h6 class="card-title text-center text-secondary mb-3">Departman Bazlı Dağılım</h6>
                        <canvas id="deptChart" style="max-height: 280px;"></canvas>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card shadow-sm p-3 h-100">
                        <h6 class="card-title text-center text-secondary mb-3">Cinsiyete Göre Dağılım</h6>
                        <canvas id="genderChart" style="max-height: 280px;"></canvas>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card shadow-sm p-3 h-100">
                        <h6 class="card-title text-center text-secondary mb-3">Çalışma Tipine Göre Dağılım</h6>
                        <canvas id="employmentTypeChart" style="max-height: 280px;"></canvas>
                    </div>
                </div>
            </div>

            <!-- Yıllara Göre İşe Başlama -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card shadow-sm p-3">
                        <h6 class="card-title text-center text-secondary mb-3">Yıllara Göre İşe Başlama (Son 5 Yıl)</h6>
                        <canvas id="employmentYearChart" style="max-height: 320px;"></canvas>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
        <div class="container py-5">
        <div class="glass-card mx-auto col-lg-12" data-aos="fade-up">
            <h1 class="mb-4 fw-bold" style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">Personel Raporu</h1>
            <p class="lead">Toplam Personel: <strong>{{ total_employees }}</strong></p>

            <!-- Personel Tablosu -->
    <div class="table-responsive">
        <table class="table table-striped table-bordered align-middle">
            <thead class="table-dark">
                <tr>
                    <th>Profil</th>
                    <th>Ad Soyad</th>
                    <th>TC Kimlik No</th>
                    <th>E-posta</th>
                    <th>Telefon</th>
                    <th>Cinsiyet</th>
                    <th>Doğum Tarihi</th>
                    <th>İşe Başlama</th>
                    <th>Unvan</th>
                    <th>Departman</th>
                    <th>Yönetici</th>
                    <th>Çalışma Tipi</th>
                    <th>Çalışma Lokasyonu</th>
                    <th>Aktif</th>
                </tr>
            </thead>
            <tbody>
                {% for emp in employees %}
                <tr>
                    <td>
                        {% if emp.profile_image %}
                            <img src="{{ emp.profile_image.url }}" alt="Profil" class="profile-img" />
                        {% else %}
                            <img src="https://via.placeholder.com/50" alt="Profil Yok" class="profile-img" />
                        {% endif %}
                    </td>
                    <td>{{ emp.first_name }} {{ emp.last_name }}</td>
                    <td>{{ emp.tc_identity }}</td>
                    <td>{{ emp.email }}</td>
                    <td>{{ emp.phone|default:"-" }}</td>
                    <td>{{ emp.get_gender_display }}</td>
                    <td>{{ emp.birth_date|date:"d.m.Y" }}</td>
                    <td>{{ emp.start_date|date:"d.m.Y" }}</td>

                    <td>
                        {% if emp.job_info_as_employee %}
                            {{ emp.job_info_as_employee.title.name }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% if emp.job_info_as_employee %}
                            {{ emp.job_info_as_employee.department.name }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% if emp.job_info_as_employee and emp.job_info_as_employee.manager %}
                            {{ emp.job_info_as_employee.manager.first_name }} {{ emp.job_info_as_employee.manager.last_name }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% if emp.job_info_as_employee %}
                            {{ emp.job_info_as_employee.get_employment_type_display }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% if emp.job_info_as_employee %}
                            {{ emp.job_info_as_employee.work_location.name }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% if emp.is_active %}
                            <span class="badge bg-success">Aktif</span>
                        {% else %}
                            <span class="badge bg-secondary">Pasif</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>

        </table>
    </div>
            
        </div>
    </div>

    

    <script>
        // Helper function to extract labels and data from queryset dicts
        function getLabelsAndData(dataList, labelKey, dataKey) {
            const labels = dataList.map(item => item[labelKey] || 'Bilinmiyor');
            const data = dataList.map(item => item[dataKey]);
            return { labels, data };
        }

        // Departman Grafiği
        const deptData = {{ dept_distribution|safe }};
        const deptChartData = getLabelsAndData(deptData, 'department__name', 'count');
        const ctxDept = document.getElementById('deptChart').getContext('2d');
        new Chart(ctxDept, {
            type: 'pie',
            data: {
                labels: deptChartData.labels,
                datasets: [{
                    data: deptChartData.data,
                    backgroundColor: [
                        '#007bff','#28a745','#dc3545','#ffc107','#6f42c1','#20c997','#fd7e14'
                    ],
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });

        // Cinsiyet Grafiği
        const genderData = {{ gender_distribution|safe }};
        const genderLabelsMap = {'M': 'Erkek', 'F': 'Kadın'};
        const genderLabels = genderData.map(g => genderLabelsMap[g.gender] || 'Bilinmiyor');
        const genderCounts = genderData.map(g => g.count);
        const ctxGender = document.getElementById('genderChart').getContext('2d');
        new Chart(ctxGender, {
            type: 'pie',
            data: {
                labels: genderLabels,
                datasets: [{
                    data: genderCounts,
                    backgroundColor: ['#007bff','#dc3545'],
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { position: 'bottom' } }
            }
        });

        // Çalışma Tipi Grafiği
        const empTypeData = {{ employment_type_distribution|safe }};
        const empTypeLabelsMap = {'Full': 'Tam Zamanlı', 'Part': 'Yarı Zamanlı', 'Contract': 'Sözleşmeli'};
        const empTypeLabels = empTypeData.map(e => empTypeLabelsMap[e.employment_type] || e.employment_type);
        const empTypeCounts = empTypeData.map(e => e.count);
        const ctxEmpType = document.getElementById('employmentTypeChart').getContext('2d');
        new Chart(ctxEmpType, {
            type: 'bar',
            data: {
                labels: empTypeLabels,
                datasets: [{
                    label: 'Personel Sayısı',
                    data: empTypeCounts,
                    backgroundColor: ['#17a2b8','#6c757d','#ffc107'],
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true }
                },
                plugins: { legend: { display: false } }
            }
        });

        // Yıllara Göre İşe Başlama Grafiği
        const yearData = {{ employment_years|safe }};
        const yearLabels = yearData.map(y => y.year);
        const yearCounts = yearData.map(y => y.count);
        const ctxYear = document.getElementById('employmentYearChart').getContext('2d');
        new Chart(ctxYear, {
            type: 'line',
            data: {
                labels: yearLabels,
                datasets: [{
                    label: 'İşe Başlayan Sayısı',
                    data: yearCounts,
                    fill: false,
                    borderColor: '#007bff',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true, precision:0 }
                }
            }
        });
    </script>
    <!-- AOS -->
    <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
    <script>
        AOS.init();
    </script>
{% endblock %}



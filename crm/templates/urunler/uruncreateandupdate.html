{% extends "crmtemplates/base.html" %}
{% block content %}
{% load static %}
{% load i18n %}
    
    <div class="container py-5">
        <div class="glass-card  col-lg-12" data-aos="fade-up">
            
            <h2 class="text-center mb-4"><i class='bx bxs-user-plus'></i>Ürünler</h2>

            <div class="btn-group mb-4" role="group" aria-label="Form toggle">
                <button type="button" id="btn-create" class="btn btn-primary active" onclick="showForm('create')">
                    Yeni Kayıt
                </button>
                <button type="button" id="btn-update" class="btn btn-outline-primary" onclick="showForm('update')">
                    Eklenen Listesi
                </button>
                <button type="button" id="btn-table" class="btn btn-outline-success" onclick="showForm('table')">
                    Tablo Göster
                </button>
            </div>

            <div class="btn-group mb-4" role="group" aria-label="Form toggle">
                <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#createCountryCollapse" aria-expanded="false" aria-controls="createCountryCollapse">
                    Katagori Oluştur
                </button>
                <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#updateCountryCollapse" aria-expanded="false" aria-controls="updateCountryCollapse">
                    Katagori Güncelle
                </button>
            </div>

            <div id="table-show" style="display:none;">
                <table id="urunTable" class="table  table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Ürün Adı</th>
                            <th>Stok Kodu</th>
                            <th>Fiyat</th>
                            <th>Aktif</th>
                            <th>Kategoriler</th>
                            <th>Oluşturulma Tarihi</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for urun in urun_list %}
                        <tr>
                            <td>{{ urun.id }}</td>
                            <td>{{ urun.name }}</td>
                            <td>{{ urun.stock_code }}</td>
                            <td>{{ urun.price }}</td>
                            <td>{% if urun.is_active %}Evet{% else %}Hayır{% endif %}</td>
                            <td>
                                {% for cat in urun.categories.all %}
                                    <span class="badge bg-primary">{{ cat.name }}</span>
                                {% empty %}
                                    -
                                {% endfor %}
                            </td>
                            <td>{{ urun.created_at|date:"d.m.Y H:i" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="collapse" id="createCountryCollapse">
                <div class="card  card-body mb-3">
                    <form method="POST" action="">
                    {% csrf_token %}
                    <h5>Yeni Katagori Oluştur</h5>
                    <div class="mb-3">
                        {{ formcreatecatagory.name.label_tag }}
                        {{ formcreatecatagory.name }}
                    </div>

                    <button type="submit" name="create_catagory_submit" class="btn btn-danger">Kaydet</button>
                    <button type="button" class="btn btn-secondary" data-bs-toggle="collapse" data-bs-target="#createCountryCollapse">İptal</button>
                    </form>
                </div>
            </div>

            <div class="collapse" id="updateCountryCollapse">
                <div class="card card-body mb-3">
                    <div class="mb-3">
                    <label for="catagorySelect" class="form-label">Katagori Seçiniz</label>
                    <select id="catagorySelect" class="form-select" onchange="toggleCountryForm(this.value)">
                        <option value="" selected>Seçiniz</option>
                        {% for catagory in catagory_list %}
                            <option value="{{ catagory.id }}">{{ catagory.name }}</option>
                        {% endfor %}
                    </select>
                    </div>
                    <form method="POST" action="" id="formcatogryupdate">
                        {% csrf_token %}
                        <input type="hidden"  id="update_catagory_id" name="update_catagory_id" value="">
                        <h5>Katagori Güncelle</h5>
                        <div class="mb-3">
                            {{ formcatogryupdate.name.label_tag }}
                            {{ formcatogryupdate.name }}
                        </div>

                        <button type="submit" name="update_catagory_submit" class="btn btn-info">Güncelle</button>
                        <button type="button" class="btn btn-secondary" data-bs-toggle="collapse" data-bs-target="#updateCountryCollapse">İptal</button>
                    </form>
                </div>
            </div>





            <div class="container mt-4" id="form-create">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}

                    {% for field in form %}
                        <div class="mb-3">
                            {{ field.label_tag }}
                            {{ field }}
                            {% if field.errors %}
                                <div class="text-danger">{{ field.errors }}</div>
                            {% endif %}
                        </div>
                    {% endfor %}

                    <button type="submit" name="create_product_button" class="btn btn-primary">Kaydet</button>
                    <a href="{% url 'product_list' %}" class="btn btn-secondary ms-2">İptal</a>
                </form>
            </div>
            
            <div id="form-update" style="display:none;">
                    <div class="mb-3">
                        <label for="productSelect" class="form-label">Ürün Seçiniz</label>
                        <select id="productSelect" class="form-select" onchange="toggleProductForm(this.value)">
                            <option value="" selected>Seçiniz</option>
                            {% for urun in urun_list %}
                                <option value="{{ urun.id }}">{{ urun.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <form method="POST" enctype="multipart/form-data" id="formproductupdate">
                        {% csrf_token %}
                        <input type="hidden" id="update_product_id" name="update_product_id" value="">

                        <h5>Ürün Güncelle</h5>

                        {% for field in UpdateProductForm %}
                            <div class="mb-3">
                                {{ field.label_tag }}
                                {{ field }}
                                {% if field.name == 'website_image' %}
                                    <img id="website_image_preview" src="" alt="Website Resmi Önizleme" style="max-width:150px; display:none; margin-top:5px;">
                                {% endif %}
                                {% if field.name == 'mobile_image' %}
                                    <img id="mobile_image_preview" src="" alt="Mobil Resmi Önizleme" style="max-width:150px; display:none; margin-top:5px;">
                                {% endif %}
                                {% if field.errors %}
                                    <div class="text-danger">{{ field.errors }}</div>
                                {% endif %}
                            </div>
                        {% endfor %}

                        <button type="submit" name="update_product_submit" class="btn btn-info">Güncelle</button>
                        <button type="button" class="btn btn-secondary" data-bs-toggle="collapse" data-bs-target="#updateCountryCollapse">İptal</button>
                    </form>
                </div>
            </div>

            



        </div>
    </div>

    


    {% if messages %}
    <div id="message-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999;">
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    </div>
    {% endif %}




    <script>
        function showForm(type) {
            const createForm = document.getElementById('form-create');
            const updateForm = document.getElementById('form-update');
            const tableShow = document.getElementById('table-show'); // 3. sayfa
            const btnCreate = document.getElementById('btn-create');
            const btnUpdate = document.getElementById('btn-update');
            const btnTable = document.getElementById('btn-table'); // 3. buton

            if(type === 'create'){
                createForm.style.display = 'block';
                updateForm.style.display = 'none';
                tableShow.style.display = 'none';

                btnCreate.classList.add('btn-primary', 'active');
                btnCreate.classList.remove('btn-outline-primary');

                btnUpdate.classList.remove('btn-primary', 'active');
                btnUpdate.classList.add('btn-outline-primary');

                btnTable.classList.remove('btn-primary', 'active');
                btnTable.classList.add('btn-outline-primary');

            } else if(type === 'update'){
                createForm.style.display = 'none';
                updateForm.style.display = 'block';
                tableShow.style.display = 'none';

                btnCreate.classList.remove('btn-primary', 'active');
                btnCreate.classList.add('btn-outline-primary');

                btnUpdate.classList.add('btn-primary', 'active');
                btnUpdate.classList.remove('btn-outline-primary');

                btnTable.classList.remove('btn-primary', 'active');
                btnTable.classList.add('btn-outline-primary');

            } else if(type === 'table'){
                createForm.style.display = 'none';
                updateForm.style.display = 'none';
                tableShow.style.display = 'block';

                btnCreate.classList.remove('btn-primary', 'active');
                btnCreate.classList.add('btn-outline-primary');

                btnUpdate.classList.remove('btn-primary', 'active');
                btnUpdate.classList.add('btn-outline-primary');

                btnTable.classList.add('btn-primary', 'active');
                btnTable.classList.remove('btn-outline-primary');
            }
        }
    </script>


    
    <script>
        function toggleCountryForm(categoryId) {
            if (!categoryId) {
                document.getElementById('formcatogryupdate').reset();
                document.getElementById('update_catagory_id').value = '';
                return;
            }

            fetch(`/catogory_detail_api/${categoryId}/`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('update_catagory_id').value = data.id;
                    document.getElementById('id_update-name').value = data.name || '';
                    console.log(`Loaded data for category ID ${categoryId}:`, data);
                })
                .catch(error => {
                    console.error('Kategori verisi alınırken hata:', error);
                });
        }
    </script>


    <script>
        function toggleProductForm(productId) {
            const form = document.getElementById('formproductupdate');

            // Eğer ürün seçilmemişse formu sıfırla
            if (!productId) {
                form.reset();
                document.getElementById('website_image_preview').style.display = 'none';
                document.getElementById('mobile_image_preview').style.display = 'none';
                document.getElementById('update_product_id').value = '';
                return;
            }

            // API'den ürün detaylarını al
            fetch(`/product_detail_api/${productId}/`)
                .then(response => response.json())
                .then(data => {
                    console.log('Ürün verisi:', data);

                    // Hidden ID alanını doldur
                    form.querySelector('#update_product_id').value = data.id;

                    // Form alanlarını doldur (prefix="update")
                    form.querySelector('#id_update-name').value = data.name || '';
                    form.querySelector('#id_update-features').value = data.features || '';
                    form.querySelector('#id_update-stock_code').value = data.stock_code || '';
                    form.querySelector('#id_update-description').value = data.description || '';
                    form.querySelector('#id_update-price').value = data.price || '';
                    form.querySelector('#id_update-warranty_period').value = data.warranty_period || '';
                    form.querySelector('#id_update-is_active').checked = data.is_active || false;

                    // Categories (SelectMultiple)
                    const categoriesSelect = form.querySelector('#id_update-categories');
                    if (categoriesSelect) {
                        for (let option of categoriesSelect.options) {
                            option.selected = data.categories.includes(parseInt(option.value));
                        }
                    }

                    // Resim önizlemeleri
                    const websitePreview = document.getElementById('website_image_preview');
                    if (data.website_image_url) {
                        websitePreview.src = data.website_image_url;
                        websitePreview.style.display = 'block';
                    } else {
                        websitePreview.style.display = 'none';
                    }

                    const mobilePreview = document.getElementById('mobile_image_preview');
                    if (data.mobile_image_url) {
                        mobilePreview.src = data.mobile_image_url;
                        mobilePreview.style.display = 'block';
                    } else {
                        mobilePreview.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Ürün verisi yüklenirken hata oluştu:', error);
                });
        }
    </script>


    <script>
        document.addEventListener('DOMContentLoaded', function() {
            $('#urunTable').DataTable({
                "paging": true,
                "pageLength": 10,
                "lengthChange": true,
                "searching": true,
                "ordering": true,
                "info": true,
                "autoWidth": false,
                "responsive": true
            });
        });
    </script>
    <!-- AOS -->
    <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
    <script>
        AOS.init();
    </script>
{% endblock %}


